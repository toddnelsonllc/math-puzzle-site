<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Test Your Mental Math</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            text-align: center;
        }
        .welcome-message {
            font-size: 18px;
            background-color: #f0f8ff;
            border: 1px solid #ddd;
            padding: 12px;
            margin-bottom: 20px;
            border-radius: 8px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        .grid {
            display: grid;
            gap: 5px;
            justify-content: center;
            margin: 20px 0;
        }
        .cell-wrapper {
            position: relative;
            width: 50px;
            height: 50px;
        }
        .cell {
            width: 100%;
            height: 100%;
            text-align: center;
            font-size: 20px;
            box-sizing: border-box;
        }
        .clue-number {
            position: absolute;
            top: 2px;
            left: 2px;
            font-size: 10px;
            color: #333;
        }
        .clues {
            max-width: 500px;
            margin: 0 auto 20px;
            text-align: left;
        }
        .clues h3 {
            margin-bottom: 5px;
        }
        .button {
            margin: 10px 0;
            padding: 10px;
            font-size: 16px;
        }
        #result {
            font-weight: bold;
            margin-top: 15px;
        }
        #timer {
            font-size: 18px;
            margin-bottom: 10px;
            transition: font-weight 0.3s;
        }
        .blink {
            animation: blink-animation 1s steps(2, start) infinite;
        }
        @keyframes blink-animation {
            0% { font-weight: normal; }
            50% { font-weight: bold; }
            100% { font-weight: normal; }
        }
    </style>
</head>
<body>
    <h1>Test Your Mental Math</h1>

    <div class="welcome-message">
        üß† <strong>Welcome!</strong> Test your mental math skills with a new puzzle each day.<br />
        Come back daily to challenge yourself and improve your speed!
    </div>

    <label for="puzzle-date">Select Archived Puzzle:</label>
    <input type="date" id="puzzle-date" min="2025-05-01" />
    <button class="button" onclick="loadPuzzleByDate()">Load Puzzle</button>

    <div id="timer">‚è± Time: 0.0 seconds</div>

    <div class="grid" id="grid"></div>

    <button class="button" onclick="checkAnswers()">Check Answers</button>
    <div id="result"></div>

    <div class="clues">
        <h3>Clues</h3>
        <ul id="across-clues"></ul>
    </div>

    <script>
        let solution = {};
        let clueNumbers = {};
        let startTime;
        let timerInterval;
        let puzzleLoaded = false;

        function startTimer() {
            startTime = Date.now();
            clearInterval(timerInterval);
            document.getElementById("timer").classList.remove("blink");
            timerInterval = setInterval(() => {
                const elapsed = (Date.now() - startTime) / 1000;
                document.getElementById("timer").textContent = "‚è± Time: " + elapsed.toFixed(1) + " seconds";
            }, 100);
        }

        function clearGrid() {
            document.getElementById("grid").innerHTML = "";
            document.getElementById("result").textContent = "";
        }

        function createGridFromData(gridData, clueNumbers) {
            const gridEl = document.getElementById("grid");
            const keys = Object.keys(gridData);
            const coords = keys.map(key => key.split('-').slice(1).map(Number));
            const maxRow = Math.max(...coords.map(([r, _]) => r));
            const maxCol = Math.max(...coords.map(([_, c]) => c));

            gridEl.style.gridTemplateColumns = `repeat(${maxCol + 1}, 50px)`;
            gridEl.style.gridTemplateRows = `repeat(${maxRow + 1}, 50px)`;

            for (let row = 0; row <= maxRow; row++) {
                for (let col = 0; col <= maxCol; col++) {
                    const key = `cell-${row}-${col}`;
                    if (gridData[key]) {
                        const wrapper = document.createElement("div");
                        wrapper.className = "cell-wrapper";

                        const number = document.createElement("div");
                        number.className = "clue-number";
                        number.textContent = clueNumbers[key] || "";
                        wrapper.appendChild(number);

                        const input = document.createElement("input");
                        input.type = "text";
                        input.className = "cell";
                        input.id = key;
                        input.maxLength = 1;
                        wrapper.appendChild(input);

                        gridEl.appendChild(wrapper);
                    } else {
                        const empty = document.createElement("div");
                        empty.style.width = "50px";
                        empty.style.height = "50px";
                        empty.style.backgroundColor = "#ddd";
                        gridEl.appendChild(empty);
                    }
                }
            }
        }

        function loadPuzzleByDate(dateOverride) {
            const selectedDate = dateOverride || document.getElementById("puzzle-date").value;
            if (!selectedDate) {
                alert("Please select a date.");
                return;
            }

            fetch(`http://127.0.0.1:5000/api/puzzles`)
                .then(res => res.json())
                .then(allPuzzles => {
                    const match = allPuzzles.find(p =>
                        (p.assigned_date || "").startsWith(selectedDate)
                    );
                    if (!match) {
                        alert("No puzzle found for this date.");
                        return;
                    }
                    loadPuzzleById(match.id);
                });
        }

        function loadPuzzleById(id) {
            fetch(`http://127.0.0.1:5000/api/puzzles/${id}`)
                .then(res => res.json())
                .then(data => {
                    solution = data.grid || {};
                    clueNumbers = data.clue_numbers || {};
                    const acrossList = document.getElementById("across-clues");

                    clearGrid();
                    acrossList.innerHTML = "";
                    createGridFromData(solution, clueNumbers);
                    startTimer();
                    puzzleLoaded = true;

                    const clues = data.clues.across || [];
                    clues.forEach(clue => {
                        const li = document.createElement("li");
                        li.textContent = clue;
                        acrossList.appendChild(li);
                    });
                })
                .catch(err => {
                    alert("Failed to load puzzle.");
                    console.error(err);
                });
        }

        function checkAnswers() {
            if (!puzzleLoaded) return;
            let correct = true;
            for (const key in solution) {
                const input = document.getElementById(key);
                if (!input) continue;
                const userAnswer = input.value.trim();
                if (userAnswer === solution[key]) {
                    input.style.backgroundColor = "#c8f7c5";
                } else {
                    input.style.backgroundColor = "#f8b4b4";
                    correct = false;
                }
            }

            if (correct) {
                clearInterval(timerInterval);
                document.getElementById("timer").classList.add("blink");
                document.getElementById("result").textContent = "‚úÖ All correct!";
            } else {
                document.getElementById("result").textContent = "‚ùå Some answers are incorrect.";
            }
        }

        // Load today's puzzle by default
        window.onload = function () {
            const today = new Date().toISOString().slice(0, 10);
            document.getElementById("puzzle-date").value = today;
            loadPuzzleByDate(today);
        }
    </script>
</body>
</html>